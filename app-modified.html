<!DOCTYPE html>
<html class="dark" lang="en">
<head>

<link rel="manifest" href="manifest.json">
<link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
<link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
<meta name="theme-color" content="#000000">
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" name="viewport"/>
<title>R Chat - Ultimate</title>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;700&display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
<script>
  tailwind.config = {
    darkMode: "class",
    theme: {
      extend: {
        colors: {
          "primary": "#1313ec",
          "background-light": "#f6f6f8",
          "background-dark": "#0a0a16",
          "surface": "#18182c",
          "surface-light": "#282839"
        },
        fontFamily: {
          "display": ["Space Grotesk", "sans-serif"]
        },
        animation: {
          'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
          'fadeIn': 'fadeInUp 0.2s ease-out forwards',
        }
      },
    },
  }
</script>
<style>
  html, body { height: 100%; overflow: hidden; touch-action: manipulation; }
  .no-scrollbar::-webkit-scrollbar { display: none; }
  .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
  .material-symbols-outlined { font-variation-settings: 'FILL' 1, 'wght' 400, 'GRAD' 0, 'opsz' 24; }
  
  .glowing-ripple {
      box-shadow: 0 0 0 0 rgba(19, 19, 236, 0.4);
      animation: ripple 1.5s infinite;
  }
  @keyframes ripple {
      0% { box-shadow: 0 0 0 0 rgba(19, 19, 236, 0.4), 0 0 0 10px rgba(19, 19, 236, 0.2); }
      100% { box-shadow: 0 0 0 10px rgba(19, 19, 236, 0.2), 0 0 0 20px rgba(19, 19, 236, 0); }
  }
  
  @keyframes fadeInUp {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .glass-panel {
    background: rgba(24, 24, 44, 0.85);
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);
    border: 1px solid rgba(255, 255, 255, 0.1);
  }
  
  video { transform: scaleX(-1); }

  /* Dropdown Menu Styles */
  .msg-menu {
    display: none;
    position: absolute;
    top: 100%;
    right: 0;
    background: #282839;
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 12px;
    padding: 4px;
    z-index: 50;
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
    min-width: 100px;
    margin-top: 4px;
  }
  .msg-menu button {
    display: block;
    width: 100%;
    text-align: left;
    padding: 8px 12px;
    font-size: 0.85rem;
    color: #cbd5e1;
    border-radius: 8px;
    transition: background 0.2s;
  }
  .msg-menu button:hover { background: rgba(255,255,255,0.1); color: white; }
  .msg-menu button.delete-btn:hover { background: rgba(239, 68, 68, 0.2); color: #ef4444; }

  /* Input override for editing */
  .edit-input {
    background: rgba(0,0,0,0.2);
    border: none;
    border-bottom: 1px solid rgba(255,255,255,0.5);
    color: white;
    width: 100%;
    padding: 4px;
    outline: none;
    border-radius: 4px 4px 0 0;
  }
</style>
</head>
<body class="bg-background-dark font-display text-white">

<div class="flex flex-col h-[100dvh] w-full overflow-hidden bg-background-dark relative">
  
  <div class="flex-none flex items-center bg-surface px-4 py-3 justify-between border-b border-white/5 z-20 shadow-md">
    <div class="flex items-center gap-3 overflow-hidden">
      <div class="relative">
        <div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-10 border border-white/10" style='background-image: url("https://i.pravatar.cc/150?img=60");'></div>
        <span id="statusDot" class="absolute bottom-0 right-0 w-3 h-3 rounded-full bg-red-500 border-2 border-surface shadow-sm transition-colors duration-300"></span>
      </div>
      <div class="flex flex-col min-w-0">
        <h2 id="contactNameDisplay" class="text-base font-bold leading-tight truncate">Waiting...</h2>
        <p id="statusText" class="text-xs text-gray-400 truncate">Disconnected</p>
      </div>
    </div>
    
    <div class="flex items-center gap-2">
      <button id="startCallBtn" disabled class="flex items-center justify-center rounded-full w-10 h-10 bg-surface-light text-gray-500 disabled:opacity-50 active:scale-95 transition-all hover:bg-surface border border-white/5">
        <span class="material-symbols-outlined">videocam</span>
      </button>

      <button id="openModalBtn" class="flex items-center justify-center rounded-full w-10 h-10 bg-surface-light active:scale-95 transition-transform hover:bg-surface border border-white/5">
        <span class="material-symbols-outlined text-gray-200">settings</span>
      </button>
    </div>
  </div>

  <div id="chatBox" class="flex-1 overflow-y-auto overflow-x-hidden p-3 flex flex-col gap-2 no-scrollbar scroll-smooth">
    <div class="flex justify-center mt-8 opacity-50">
      <p class="text-gray-500 text-xs uppercase tracking-widest">Secure P2P Connection</p>
    </div>
  </div>

  <div class="flex-none bg-surface p-2 pb-[env(safe-area-inset-bottom,20px)] border-t border-white/5 z-20">
    <div class="flex items-end gap-2 max-w-4xl mx-auto">
      <button id="fileBtn" class="flex-shrink-0 w-10 h-10 flex items-center justify-center rounded-full text-gray-400 hover:bg-surface-light active:text-white transition-colors">
        <span class="material-symbols-outlined">attach_file</span>
      </button>
      <input type="file" id="fileInput" style="display:none" accept="*/*" />

      <div class="flex-1 bg-surface-light rounded-2xl flex items-center px-4 py-2 min-h-[48px]">
        <input id="msgIn" class="w-full bg-transparent text-white border-none focus:ring-0 p-0 text-base placeholder-gray-500" placeholder="Message..." type="text" autocomplete="off"/>
      </div>
      
      <button id="sendBtn" class="flex-shrink-0 w-12 h-12 bg-primary rounded-full flex items-center justify-center text-white shadow-lg active:scale-90 transition-transform glowing-ripple">
        <span class="material-symbols-outlined text-[24px]">send</span>
      </button>
    </div>
  </div>
</div>

<div id="incomingCallAlert" class="fixed top-0 left-0 right-0 z-[70] p-4 transform -translate-y-full transition-transform duration-500 ease-out">
  <div class="bg-surface/95 backdrop-blur-xl border border-primary/30 shadow-[0_0_30px_rgba(19,19,236,0.3)] rounded-2xl p-4 max-w-sm mx-auto flex items-center justify-between">
    <div class="flex items-center gap-3">
        <div class="relative">
            <div class="w-12 h-12 rounded-full bg-gray-700 bg-cover border-2 border-primary animate-pulse-slow" style='background-image: url("https://i.pravatar.cc/150?img=32")'></div>
        </div>
        <div>
            <h3 id="callerNameDisplay" class="font-bold text-white text-sm">Incoming Call...</h3>
            <p class="text-xs text-primary animate-pulse">Video Request</p>
        </div>
    </div>
    <div class="flex gap-3">
        <button id="declineCallBtn" class="w-10 h-10 rounded-full bg-red-500/20 text-red-500 flex items-center justify-center hover:bg-red-500 hover:text-white transition-colors">
            <span class="material-symbols-outlined text-[20px]">call_end</span>
        </button>
        <button id="acceptCallBtn" class="w-10 h-10 rounded-full bg-green-500 text-white flex items-center justify-center shadow-lg shadow-green-500/30 hover:scale-110 transition-transform">
            <span class="material-symbols-outlined text-[20px]">videocam</span>
        </button>
    </div>
  </div>
</div>

<div id="callOverlay" class="fixed inset-0 z-[80] bg-background-dark hidden opacity-0 transition-opacity duration-500 flex-col">
    <div class="absolute inset-0 flex items-center justify-center bg-gray-900">
        <div id="remotePlaceholder" class="text-center opacity-30 absolute z-0">
            <span class="material-symbols-outlined text-6xl mb-2">person_off</span>
            <p class="text-sm tracking-widest uppercase">Connecting to Peer...</p>
        </div>
        <video id="remoteVideo" autoplay playsinline class="absolute inset-0 w-full h-full object-cover z-10"></video>
        <div class="absolute top-safe-area top-6 left-1/2 -translate-x-1/2 glass-panel px-4 py-1.5 rounded-full flex items-center gap-2 shadow-lg z-20">
            <div id="videoStatusDot" class="w-2 h-2 rounded-full bg-yellow-500 animate-pulse"></div>
            <span id="videoStatusText" class="text-xs font-medium tracking-wide">Connecting...</span>
        </div>
    </div>
    <div id="localVideoContainer" class="absolute top-6 right-6 w-[100px] sm:w-[140px] aspect-[3/4] bg-gray-800 rounded-2xl overflow-hidden border border-white/20 shadow-2xl z-30 cursor-move transition-transform hover:scale-105">
        <video id="localVideo" autoplay playsinline muted class="w-full h-full object-cover"></video>
    </div>
    <div class="absolute bottom-10 left-0 right-0 flex justify-center z-30 pb-[env(safe-area-inset-bottom,20px)]">
        <div class="glass-panel p-2 rounded-full flex items-center gap-4 shadow-2xl">
            <button id="toggleMicBtn" class="w-12 h-12 rounded-full bg-white/10 hover:bg-white/20 flex items-center justify-center transition-all active:scale-95">
                <span class="material-symbols-outlined">mic</span>
            </button>
            <button id="toggleVideoBtn" class="w-12 h-12 rounded-full bg-white/10 hover:bg-white/20 flex items-center justify-center transition-all active:scale-95">
                <span class="material-symbols-outlined">videocam</span>
            </button>
            <button id="hangupBtn" class="w-14 h-14 rounded-full bg-red-500 text-white shadow-lg shadow-red-500/40 flex items-center justify-center transition-all hover:bg-red-600 active:scale-95">
                <span class="material-symbols-outlined text-[28px]">call_end</span>
            </button>
        </div>
    </div>
</div>

<div id="p2pModal" class="fixed inset-0 bg-black/90 backdrop-blur-md z-50 hidden flex flex-col justify-end sm:justify-center opacity-0 transition-opacity duration-300">
  <div class="bg-surface border-t sm:border border-white/10 rounded-t-3xl sm:rounded-2xl p-6 w-full sm:w-[90%] sm:max-w-md shadow-2xl transform translate-y-full sm:translate-y-0 transition-transform duration-300" id="modalContent">
    <div class="w-12 h-1 bg-white/20 rounded-full mx-auto mb-6 sm:hidden"></div> 
    <div class="flex justify-between items-center mb-6">
      <h3 class="text-xl font-bold text-white">Setup Connection</h3>
      <button id="closeModal" class="text-gray-400 p-2"><span class="material-symbols-outlined">close</span></button>
    </div>
    <div class="space-y-5 pb-6">
      <div>
        <label class="block text-xs font-medium text-gray-400 mb-2 uppercase tracking-wider">1. Your Identity</label>
        <div class="flex gap-3">
          <input id="myName" class="flex-1 bg-background-dark border border-white/10 rounded-xl px-4 py-3 text-white focus:border-primary outline-none" placeholder="Enter name" />
          <button id="registerBtn" class="bg-surface-light border border-white/10 text-white px-5 rounded-xl active:bg-primary transition-colors font-medium">Set</button>
        </div>
      </div>
      <div class="relative py-2">
        <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-white/10"></div></div>
        <div class="relative flex justify-center"><span class="bg-surface px-2 text-gray-500 text-xs">THEN</span></div>
      </div>
      <div>
        <label class="block text-xs font-medium text-gray-400 mb-2 uppercase tracking-wider">2. Connect to Friend</label>
        <div class="flex gap-3">
          <input id="friendName" class="flex-1 bg-background-dark border border-white/10 rounded-xl px-4 py-3 text-white focus:border-primary outline-none" placeholder="Friend's Name" />
          <button id="inviteBtn" class="bg-primary text-white px-5 rounded-xl active:bg-blue-600 transition-colors font-medium shadow-lg shadow-blue-900/20">Connect</button>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="imageViewer" class="fixed inset-0 z-[60] bg-black/95 hidden flex flex-col opacity-0 transition-opacity duration-300">
  <div class="flex justify-between items-center p-4 absolute top-0 w-full bg-gradient-to-b from-black/50 to-transparent z-10">
    <button id="closeViewerBtn" class="p-2 bg-white/10 rounded-full text-white hover:bg-white/20 backdrop-blur-md transition-colors">
      <span class="material-symbols-outlined">arrow_back</span>
    </button>
    <a id="downloadViewerBtn" href="#" download="image.png" class="p-2 bg-white/10 rounded-full text-white hover:bg-white/20 backdrop-blur-md transition-colors flex items-center gap-2 px-4">
      <span class="material-symbols-outlined text-[20px]">download</span>
      <span class="text-sm font-medium">Save</span>
    </a>
  </div>
  <div class="flex-1 flex items-center justify-center p-2 overflow-hidden">
    <img id="fullImage" src="" class="max-w-full max-h-full object-contain shadow-2xl transition-transform duration-300 scale-95" />
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, collection, doc, addDoc, getDoc, setDoc, updateDoc, onSnapshot, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAMMKN8XcoTa7RNCrT1aHNJ8hHK-vaP5UY",
  authDomain: "rchatv1-2e2cc.firebaseapp.com",
  projectId: "rchatv1-2e2cc",
  storageBucket: "rchatv1-2e2cc.appspot.com",
  messagingSenderId: "521047055183",
  appId: "1:521047055183:web:76cc4a688f84e6059bc33a"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
signInAnonymously(auth);

/* --- Elements --- */
const el = id => document.getElementById(id);
const chatBox = el('chatBox');
const msgIn = el('msgIn');
const sendBtn = el('sendBtn');
const fileBtn = el('fileBtn');
const fileInput = el('fileInput');
const statusDot = el('statusDot');
const statusText = el('statusText');
const startCallBtn = el('startCallBtn');
const contactNameDisplay = el('contactNameDisplay');

let chatPC, dc, dcRemote; 
let videoPC;
let localStream = null;
let remoteStream = null;
let currentVideoInviteRef = null;
let myName, friendName, mySanitized, friendSanitized;
const incomingFiles = {};

const CHUNK_SIZE = 16384; // 16KB
const RINGTONE_URL = "https://ravjit-singh.github.io/rchat/ring.mp3.mp3";
const ringtoneAudio = new Audio(); ringtoneAudio.loop = true;

const sanitizeName = n => n ? n.trim().toLowerCase().replace(/\s+/g,'_').replace(/[^\w\-]/g,'') : '';

/* --- Modal Logic --- */
el('openModalBtn').onclick = () => { el('p2pModal').classList.remove('hidden'); setTimeout(()=> { el('p2pModal').classList.remove('opacity-0'); el('modalContent').classList.remove('translate-y-full'); }, 10); };
el('closeModal').onclick = () => { el('p2pModal').classList.add('opacity-0'); el('modalContent').classList.add('translate-y-full'); setTimeout(()=> el('p2pModal').classList.add('hidden'), 300); };

function setChatStatus(txt){
    statusText.textContent = txt;
    if(txt === "Connected") {
        statusDot.className = "absolute bottom-0 right-0 w-3 h-3 rounded-full bg-green-500 border-2 border-surface shadow-[0_0_8px_rgba(34,197,94,0.6)] transition-all duration-300";
        startCallBtn.disabled = false;
        startCallBtn.classList.remove('text-gray-500'); startCallBtn.classList.add('text-primary');
    } else {
        statusDot.className = "absolute bottom-0 right-0 w-3 h-3 rounded-full bg-red-500 border-2 border-surface";
        startCallBtn.disabled = true;
        startCallBtn.classList.add('text-gray-500'); startCallBtn.classList.remove('text-primary');
    }
}

/* --- CHAT Logic --- */
const rtcConfig = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };

function createChatPC(){
    if(chatPC) return chatPC;
    chatPC = new RTCPeerConnection(rtcConfig);
    chatPC.oniceconnectionstatechange = () => setChatStatus(chatPC.iceConnectionState === "connected" ? "Connected" : chatPC.iceConnectionState);
    chatPC.ondatachannel = e => { dcRemote = e.channel; setupDC(dcRemote); };
    return chatPC;
}

function setupDC(ch){
    ch.onopen = () => setChatStatus("Connected");
    ch.onmessage = e => handleMsg(e, ch);
}

// Close menus on click away
document.addEventListener('click', () => {
    document.querySelectorAll('.msg-menu').forEach(menu => {
        if (menu.style.display === 'block') menu.style.display = 'none';
    });
});

function logChat(content, who, id=null, isText=true){
    const msgId = id || Date.now();
    const wrapper = document.createElement("div");
    wrapper.className = who === "mine" 
        ? "flex items-end gap-2 justify-end animate-fadeIn group relative" 
        : "flex items-end gap-2 animate-fadeIn relative";
    wrapper.dataset.msgId = msgId;

    const bubble = document.createElement("div");
    const isImage = content instanceof HTMLElement && content.classList.contains("aspect-square");
    
    let bubbleClass = "relative text-[15px] font-normal leading-snug max-w-[75%] shadow-sm break-words transition-all msg-content";
    if (isImage) {
        bubbleClass += " p-0.5 rounded-xl bg-transparent"; 
    } else {
        bubbleClass += " px-4 py-3 rounded-2xl"; 
        if(who === "mine") bubbleClass += " bg-primary text-white rounded-br-none";
        else bubbleClass += " bg-surface-light text-white rounded-bl-none border border-white/5";
    }
    bubble.className = bubbleClass;

    if(typeof content === "string") {
        const span = document.createElement("span");
        span.className = "msg-text";
        span.textContent = content;
        bubble.appendChild(span);
    } else {
        bubble.appendChild(content);
    }

    if(who === "their"){
        const av = document.createElement("div");
        av.className = "w-6 h-6 rounded-full bg-gray-700 bg-cover flex-shrink-0 mb-1";
        av.style.backgroundImage = 'url("https://i.pravatar.cc/150?img=32")';
        wrapper.appendChild(av);
        wrapper.appendChild(bubble);
    } else {
        wrapper.appendChild(bubble);
        
        const actionsBtn = document.createElement("button");
        actionsBtn.className = "opacity-0 group-hover:opacity-100 transition-opacity absolute -top-3 right-0 bg-surface border border-white/10 rounded-full w-6 h-6 flex items-center justify-center shadow-lg text-gray-400 hover:text-white";
        actionsBtn.innerHTML = '<span class="material-symbols-outlined text-[14px]">more_horiz</span>';
        actionsBtn.onclick = (e) => {
            e.stopPropagation();
            const menu = wrapper.querySelector('.msg-menu');
            const isVisible = menu.style.display === 'block';
            document.querySelectorAll('.msg-menu').forEach(m => m.style.display = 'none');
            menu.style.display = isVisible ? 'none' : 'block';
        };
        wrapper.appendChild(actionsBtn);

        const menu = document.createElement("div");
        menu.className = "msg-menu";
        
        if(isText && !isImage) {
            const editBtn = document.createElement("button");
            editBtn.textContent = "Edit";
            editBtn.onclick = (e) => { e.stopPropagation(); menu.style.display='none'; startEditMessage(msgId); };
            menu.appendChild(editBtn);
        }

        const delBtn = document.createElement("button");
        delBtn.textContent = "Delete";
        delBtn.className = "delete-btn";
        delBtn.onclick = (e) => { e.stopPropagation(); menu.style.display='none'; performDelete(msgId, true); };
        menu.appendChild(delBtn);
        
        wrapper.appendChild(menu);
    }

    chatBox.appendChild(wrapper);
    chatBox.scrollTop = chatBox.scrollHeight;
    return wrapper;
}

function startEditMessage(id) {
    const wrapper = document.querySelector(`div[data-msg-id="${id}"]`);
    if(!wrapper) return;
    const bubble = wrapper.querySelector('.msg-content');
    const textSpan = bubble.querySelector('.msg-text');
    if(!textSpan) return;

    const oldText = textSpan.textContent;
    bubble.innerHTML = ''; 

    const input = document.createElement("input");
    input.type = "text";
    input.value = oldText;
    input.className = "edit-input";
    
    input.onkeydown = (e) => {
        if(e.key === 'Enter') saveEditMessage(id, input.value);
        if(e.key === 'Escape') { bubble.innerHTML = ''; const s = document.createElement('span'); s.className='msg-text'; s.textContent = oldText; bubble.appendChild(s); }
    };

    bubble.appendChild(input);
    input.focus();
}

function saveEditMessage(id, newText) {
    const wrapper = document.querySelector(`div[data-msg-id="${id}"]`);
    if(!wrapper) return;
    const bubble = wrapper.querySelector('.msg-content');
    if(!newText.trim()) return;

    bubble.innerHTML = '';
    const span = document.createElement("span");
    span.className = "msg-text";
    span.textContent = newText;
    bubble.appendChild(span);

    const ch = dc || dcRemote;
    if(ch && ch.readyState === "open") ch.send(JSON.stringify({ type: "edit", id: id, text: newText }));
}

function performDelete(id, notifyPeer) {
    const wrapper = document.querySelector(`div[data-msg-id="${id}"]`);
    if(!wrapper) return;
    const bubble = wrapper.querySelector('.msg-content');
    
    bubble.innerHTML = '<span class="italic text-white/50 text-sm flex items-center gap-1"><span class="material-symbols-outlined text-sm">block</span> Message deleted</span>';
    
    const btn = wrapper.querySelector('button');
    if(btn) btn.remove();

    if(notifyPeer) {
        const ch = dc || dcRemote;
        if(ch && ch.readyState === "open") ch.send(JSON.stringify({ type: "delete", id: id }));
    }
}

function createImagePreview(blobUrl, name, clickToOpen = true) {
    const imgContainer = document.createElement("div");
    imgContainer.className = "aspect-square w-full max-w-[260px] min-w-[120px] cursor-pointer group relative overflow-hidden rounded-xl bg-surface-light border border-white/10";
    const img = document.createElement("img");
    img.src = blobUrl;
    img.className = "w-full h-full object-cover transition-transform duration-500 group-hover:scale-110";
    if(clickToOpen) {
        img.onclick = () => openImageViewer(blobUrl, name);
        const hint = document.createElement("div");
        hint.className = "absolute inset-0 bg-black/0 group-hover:bg-black/20 transition-colors flex items-center justify-center pointer-events-none";
        hint.innerHTML = '<span class="material-symbols-outlined text-white opacity-0 group-hover:opacity-100 transition-opacity drop-shadow-md">zoom_in_map</span>';
        imgContainer.appendChild(hint);
    }
    imgContainer.appendChild(img);
    return imgContainer;
}

function handleMsg(e, ch){
    if(typeof e.data === "string"){
        try {
            const d = JSON.parse(e.data);
            if(d.type === "chat") logChat(d.text, "their", d.id, true);
            if(d.type === "edit") {
                const w = document.querySelector(`div[data-msg-id="${d.id}"]`);
                if(w) { const t = w.querySelector('.msg-text'); if(t) t.textContent = d.text; }
            }
            if(d.type === "delete") performDelete(d.id, false);
            if(d.type === "file-meta") {
                incomingFiles[d.id] = { ...d, chunks: [], received: 0 };
                const holder = document.createElement("div");
                holder.className = "flex items-center gap-2 italic text-sm text-gray-300 px-2 py-1";
                holder.innerHTML = `<span class="material-symbols-outlined animate-spin text-sm">sync</span> Receiving ${d.name}...`;
                incomingFiles[d.id].elWrapper = logChat(holder, "their", d.id, false); 
            }
        } catch(err) { logChat(e.data, "their"); }
    } else {
        const ids = Object.keys(incomingFiles);
        if(!ids.length) return;
        const f = incomingFiles[ids[0]];
        f.chunks.push(e.data); f.received += e.data.byteLength;
        if(f.received >= f.size){
            const blob = new Blob(f.chunks, {type: f.ftype});
            const blobUrl = URL.createObjectURL(blob);
            let elContent;
            
            if(f.ftype.startsWith("image/")){
                elContent = createImagePreview(blobUrl, f.name, true);
            } else {
                elContent = document.createElement("a");
                elContent.href = blobUrl;
                elContent.download = f.name;
                elContent.className = "flex items-center gap-2 text-blue-300 underline mt-1 p-2 bg-black/20 rounded-lg";
                elContent.innerHTML = `<span class="material-symbols-outlined">download</span> ${f.name}`;
            }
            
            const bubble = f.elWrapper.lastElementChild; 
            if(bubble) {
                bubble.innerHTML = "";
                if(f.ftype.startsWith("image/")) bubble.className = "relative max-w-[75%] shadow-sm break-words transition-all p-0.5 rounded-xl bg-transparent animate-fadeIn msg-content";
                bubble.appendChild(elContent);
            }
            delete incomingFiles[ids[0]];
        }
    }
}

sendBtn.onclick = () => {
    const msg = msgIn.value.trim(); if(!msg) return;
    const ch = dc || dcRemote;
    if(ch && ch.readyState === "open"){
        const id = Date.now();
        ch.send(JSON.stringify({type:"chat", id, text:msg}));
        logChat(msg, "mine", id, true);
        msgIn.value = "";
    }
};
msgIn.onkeypress = (e) => { if(e.key==="Enter") sendBtn.click(); }

fileBtn.onclick = () => fileInput.click();

/* --- FIXED FILE SENDING LOGIC (Using Async/Await) --- */
fileInput.onchange = async () => {
    const file = fileInput.files[0]; if(!file) return;
    const ch = dc || dcRemote; if(!ch || ch.readyState !== "open") { alert("Chat Connect first!"); return; }
    
    const id = Date.now();
    const blobUrl = URL.createObjectURL(file);
    let previewEl;
    let isImg = false;
    
    if(file.type.startsWith("image/")) {
        previewEl = createImagePreview(blobUrl, file.name, true);
        previewEl.querySelector('img').classList.add('opacity-70'); 
        isImg = true;
    } else {
        previewEl = document.createElement("div");
        previewEl.className = "flex items-center gap-2";
        previewEl.innerHTML = `<span class="material-symbols-outlined">description</span> ${file.name}`;
    }
    
    logChat(previewEl, "mine", id, false); 
    ch.send(JSON.stringify({type:"file-meta", id, name:file.name, size:file.size, ftype:file.type}));
    
    let offset = 0;
    try {
        while(offset < file.size){
            const slice = file.slice(offset, offset + CHUNK_SIZE);
            const buffer = await slice.arrayBuffer(); 
            if (ch.bufferedAmount > 16000000) await new Promise(r => setTimeout(r, 10)); // Throttle
            ch.send(buffer);
            offset += CHUNK_SIZE;
        }
        if(isImg) previewEl.querySelector('img').classList.remove("opacity-70");
        fileInput.value = ""; 
    } catch(err) { console.error(err); alert("Transfer failed"); }
}

/* --- FIREBASE & VIDEO Logic --- */
async function registerUser(name){
    myName = name; 
    mySanitized = sanitizeName(name);
    await setDoc(doc(db, "users", myName), { online: true }, { merge: true });
    setChatStatus(`ID: ${myName}`);
    onSnapshot(doc(db, "users", myName), async s => {
        const d = s.data();
        if(d && d.invite && d.invite.status === "pending"){
            if(confirm(`Chat request from ${d.invite.from}?`)){
                friendName = d.invite.from;
                friendSanitized = sanitizeName(friendName);
                contactNameDisplay.textContent = friendName;
                await updateDoc(doc(db, "users", myName), { invite: { ...d.invite, status: "accepted" } });
                await joinRoomFirestore(d.invite.roomId);
                el('p2pModal').classList.add('hidden');
            }
        }
    });
    onSnapshot(doc(db, 'vc_invites', mySanitized), async snap => {
        const data = snap.data();
        if(!data || data._handled) return;
        if(data.offer && data.from && data.from !== mySanitized){
            currentVideoInviteRef = doc(db, 'vc_invites', mySanitized);
            friendSanitized = data.from; 
            el('callerNameDisplay').textContent = (data.fromDisplay || data.from) + " is calling...";
            ringtoneAudio.src = RINGTONE_URL;
            ringtoneAudio.play().catch(e=>{});
            el('incomingCallAlert').classList.remove('-translate-y-full');
            el('declineCallBtn').onclick = async () => {
                ringtoneAudio.pause();
                el('incomingCallAlert').classList.add('-translate-y-full');
                await updateDoc(currentVideoInviteRef, { _handled: true, accepted: false });
            };
            el('acceptCallBtn').onclick = async () => {
                ringtoneAudio.pause();
                el('incomingCallAlert').classList.add('-translate-y-full');
                startActiveCallUI(); 
                const success = await openLocalMedia();
                if(!success) return;
                createVideoPC('callee');
                await videoPC.setRemoteDescription(data.offer);
                const answer = await videoPC.createAnswer();
                await videoPC.setLocalDescription(answer);
                await updateDoc(currentVideoInviteRef, { answer: { type: videoPC.localDescription.type, sdp: videoPC.localDescription.sdp }, answeredAt: Date.now(), accepted: true, _handled: true });
                onSnapshot(collection(currentVideoInviteRef, 'callerCandidates'), snap => { snap.docChanges().forEach(c => { if(c.type==='added') videoPC.addIceCandidate(c.doc.data()); }); });
            };
        }
    });
}

async function sendInvite(friend){
    friendName = friend;
    friendSanitized = sanitizeName(friend);
    contactNameDisplay.textContent = friendName;
    const roomId = Date.now().toString();
    await createRoomFirestore(roomId);
    await updateDoc(doc(db, "users", friend), { invite: { from: myName, status: "pending", roomId } });
    el('p2pModal').classList.add('hidden');
}

async function createRoomFirestore(roomId){
    chatPC = createChatPC(); dc = chatPC.createDataChannel("chat"); setupDC(dc);
    const ref = doc(db, "rooms", roomId); await setDoc(ref, { createdAt: Date.now() });
    chatPC.onicecandidate = e => { if(e.candidate) addDoc(collection(ref, "callerCandidates"), e.candidate.toJSON()); };
    const offer = await chatPC.createOffer(); await chatPC.setLocalDescription(offer);
    await updateDoc(ref, { offer: { type: offer.type, sdp: offer.sdp } });
    onSnapshot(ref, s => { if(s.data()?.answer && !chatPC.currentRemoteDescription) chatPC.setRemoteDescription(new RTCSessionDescription(s.data().answer)); });
    onSnapshot(collection(ref, "calleeCandidates"), snap => { snap.docChanges().forEach(c => { if(c.type==="added") chatPC.addIceCandidate(new RTCIceCandidate(c.doc.data())); }); });
}

async function joinRoomFirestore(roomId){
    const ref = doc(db, "rooms", roomId); const snap = await getDoc(ref); if(!snap.exists()) return;
    chatPC = createChatPC(); 
    onSnapshot(collection(ref, "callerCandidates"), snap => { snap.docChanges().forEach(c => { if(c.type==="added") chatPC.addIceCandidate(new RTCIceCandidate(c.doc.data())); }); });
    chatPC.onicecandidate = e => { if(e.candidate) addDoc(collection(ref, "calleeCandidates"), e.candidate.toJSON()); };
    await chatPC.setRemoteDescription(new RTCSessionDescription(snap.data().offer));
    const ans = await chatPC.createAnswer(); await chatPC.setLocalDescription(ans);
    await updateDoc(ref, { answer: { type: ans.type, sdp: ans.sdp } });
}

/* --- VIDEO --- */
async function openLocalMedia() {
    try {
        localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        el('localVideo').srcObject = localStream;
        return true;
    } catch (err) { alert("Camera access denied: " + err.message); return false; }
}

function createVideoPC(role) {
    if (videoPC) videoPC.close();
    videoPC = new RTCPeerConnection(rtcConfig);
    videoPC.onicecandidate = event => { if(event.candidate && currentVideoInviteRef){ const colName = (role === 'caller') ? 'callerCandidates' : 'calleeCandidates'; addDoc(collection(currentVideoInviteRef, colName), event.candidate.toJSON()); } };
    videoPC.onconnectionstatechange = () => { if(videoPC.connectionState === 'connected') { el('videoStatusText').textContent = "Live"; el('videoStatusDot').className = "w-2 h-2 rounded-full bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.8)]"; el('remotePlaceholder').classList.add('hidden'); } else if (videoPC.connectionState === 'disconnected' || videoPC.connectionState === 'failed') { endCallUI(); } };
    videoPC.ontrack = ev => { if(!remoteStream) { remoteStream = new MediaStream(); el('remoteVideo').srcObject = remoteStream; } remoteStream.addTrack(ev.track); };
    if(localStream){ localStream.getTracks().forEach(track => videoPC.addTrack(track, localStream)); }
    return videoPC;
}

startCallBtn.onclick = async () => {
    if(!friendName || !friendSanitized) { alert("Connect to a friend first via settings."); return; }
    const success = await openLocalMedia(); if(!success) return;
    startActiveCallUI();
    el('videoStatusText').textContent = "Calling...";
    const inviteDoc = doc(db, 'vc_invites', friendSanitized); currentVideoInviteRef = inviteDoc;
    createVideoPC('caller');
    const offer = await videoPC.createOffer(); await videoPC.setLocalDescription(offer);
    await setDoc(inviteDoc, { from: mySanitized, fromDisplay: myName, createdAt: Date.now(), offer: { type: videoPC.localDescription.type, sdp: videoPC.localDescription.sdp }, answered: false, accepted: false });
    onSnapshot(inviteDoc, async snap => { const data = snap.data(); if(!data) return; if(data.answer && data.answer.sdp && !videoPC.currentRemoteDescription){ await videoPC.setRemoteDescription(data.answer); el('videoStatusText').textContent = "Connecting..."; } });
    onSnapshot(collection(inviteDoc, 'calleeCandidates'), snap => { snap.docChanges().forEach(c => { if(c.type==='added') videoPC.addIceCandidate(c.doc.data()); }); });
};

function startActiveCallUI() { el('callOverlay').classList.remove('hidden'); setTimeout(() => el('callOverlay').classList.remove('opacity-0'), 10); }
function endCallUI() { el('callOverlay').classList.add('opacity-0'); setTimeout(() => { el('callOverlay').classList.add('hidden'); if(localStream) { localStream.getTracks().forEach(t => t.stop()); localStream = null; } if(videoPC) { videoPC.close(); videoPC = null; } el('remoteVideo').srcObject = null; el('localVideo').srcObject = null; }, 500); }
el('hangupBtn').onclick = async () => { endCallUI(); if(currentVideoInviteRef) { try { await deleteDoc(currentVideoInviteRef); } catch(e){} } };

let micEnabled = true;
el('toggleMicBtn').onclick = () => { if(localStream){ const track = localStream.getAudioTracks()[0]; if(track) track.enabled = !track.enabled; micEnabled = track ? track.enabled : false; } el('toggleMicBtn').innerHTML = micEnabled ? '<span class="material-symbols-outlined">mic</span>' : '<span class="material-symbols-outlined text-red-400">mic_off</span>'; };
let camEnabled = true;
el('toggleVideoBtn').onclick = () => { if(localStream){ const track = localStream.getVideoTracks()[0]; if(track) track.enabled = !track.enabled; camEnabled = track ? track.enabled : false; } el('toggleVideoBtn').innerHTML = camEnabled ? '<span class="material-symbols-outlined">videocam</span>' : '<span class="material-symbols-outlined text-red-400">videocam_off</span>'; };

/* --- Init --- */
el("registerBtn").onclick = () => { const n=el("myName").value.trim(); if(n) registerUser(n); };
el("inviteBtn").onclick = () => { const f=el("friendName").value.trim(); if(f) sendInvite(f); };

/* --- Viewer --- */
function openImageViewer(src, filename) { el('fullImage').src = src; el('downloadViewerBtn').href = src; el('downloadViewerBtn').download = filename || 'rchat-image.png'; el('imageViewer').classList.remove('hidden'); setTimeout(() => { el('imageViewer').classList.remove('opacity-0'); el('fullImage').classList.remove('scale-95'); el('fullImage').classList.add('scale-100'); }, 10); }
el('closeViewerBtn').onclick = () => { el('imageViewer').classList.add('opacity-0'); setTimeout(() => el('imageViewer').classList.add('hidden'), 300); };

</script>
</body>
</html>
